name: Train Lightweight Models

on:
  workflow_dispatch:
    inputs:
      train_naive_bayes:
        description: 'Train Naive Bayes model'
        required: false
        type: boolean
        default: true
      train_doc2vec:
        description: 'Train Doc2Vec model'
        required: false
        type: boolean
        default: true
      upload_to_hf:
        description: 'Upload models to HuggingFace (if quality threshold met)'
        required: false
        type: boolean
        default: true
      min_f1_threshold:
        description: 'Minimum F1 score for upload'
        required: false
        type: string
        default: '0.70'

env:
  ARTIFACTS_DIR: 'artifacts'
  NB_MODEL_DIR: 'NaiveBayes'
  NB_SUBDIR: 'nb'
  NB_HF_REPO: 'theluantran/cefr-naive-bayes'
  D2V_MODEL_DIR: 'Doc2Vec'
  D2V_SUBDIR: 'doc2vec'
  D2V_HF_REPO: 'theluantran/cefr-doc2vec'
  PYTHONPATH: ${{ github.workspace }}/code

jobs:
  train-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          path: code

      - name: Checkout training data (private)
        uses: actions/checkout@v4
        with:
          repository: luantran/cefr_data_private
          token: ${{ secrets.DATA_REPO_TOKEN }}
          path: code/dataset
          lfs: true

      - name: Verify data download
        run: |
            ls -lh code/dataset/
            echo "Train set:" && wc -l code/dataset/splits/train_100k.csv
            echo "Test set:" && wc -l code/dataset/splits/test_other_corpora.csv
            echo "Other set:" && wc -l code/dataset/splits/remaining_samples.csv

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: code/requirements.txt

      - name: Install dependencies
        run: |
          cd code
          pip install -r requirements.txt

      - name: Train Naive Bayes
        if: inputs.train_naive_bayes
        working-directory: ./code
        run: |
          python src/scripts/train_nb.py \
          --model ${{ env.NB_MODEL_DIR }} \
          --output-dir ${{ env.ARTIFACTS_DIR }} \
          --subdir ${{ env.NB_SUBDIR }}

      - name: Get Evaluation metrics (Naive Bayes)
        if: inputs.train_naive_bayes
        id: evaluate_nb
        working-directory: ./code
        run: |
          cat ${{ env.ARTIFACTS_DIR }}/${{ env.NB_MODEL_DIR }}/experiment_summary.txt
          
          NB_F1=$(jq -r '.in_domain_test_results.classification_metrics.weighted_avg.f1' \
            ${{ env.ARTIFACTS_DIR }}/${{ env.NB_MODEL_DIR }}/results.json)
          echo "nb_f1=$NB_F1" >> $GITHUB_OUTPUT

      - name: Upload NB to HuggingFace
        if: |
          inputs.train_naive_bayes &&
          inputs.upload_to_hf &&
          steps.evaluate_nb.outputs.nb_f1 != '' &&
          steps.evaluate_nb.outputs.nb_f1 > inputs.min_f1_threshold
        working-directory: ./code
        run: |
          python src/scripts/upload.py \
            --dir ${{ env.ARTIFACTS_DIR }}/${{ env.NB_MODEL_DIR }}/${{ env.NB_SUBDIR }} \
            --token ${{ secrets.HF_TOKEN }} \
            --repo-id ${{ env.NB_HF_REPO }}

      - name: Train Doc2Vec Model
        if: inputs.train_doc2vec
        working-directory: ./code
        run: |
          python src/scripts/train_doc2vec.py \
          --model ${{ env.D2V_MODEL_DIR }} \
          --output-dir ${{ env.ARTIFACTS_DIR }} \
          --subdir ${{ env.D2V_SUBDIR }}

      - name: Get Evaluation metrics (Doc2Vec)
        if: inputs.train_doc2vec
        id: evaluate_d2v
        working-directory: ./code
        run: |
          cat ${{ env.ARTIFACTS_DIR }}/${{ env.D2V_MODEL_DIR }}/experiment_summary.txt

          NB_F1=$(jq -r '.in_domain_test_results.classification_metrics.weighted_avg.f1' \
            ${{ env.ARTIFACTS_DIR }}/${{ env.D2V_MODEL_DIR }}/results.json)
          echo "nb_f1=$NB_F1" >> $GITHUB_OUTPUT

      - name: Upload Doc2Vec to HuggingFace
        if: |
          inputs.train_doc2vec &&
          inputs.upload_to_hf &&
          steps.evaluate_d2v.outputs.nb_f1 != '' &&
          steps.evaluate_d2v.outputs.nb_f1 > inputs.min_f1_threshold
        working-directory: ./code
        run: |
          python src/scripts/upload.py \
            --dir ${{ env.ARTIFACTS_DIR }}/${{ env.D2V_MODEL_DIR }}/${{ env.D2V_SUBDIR }} \
            --token ${{ secrets.HF_TOKEN }} \
            --repo-id ${{ env.D2V_HF_REPO }}